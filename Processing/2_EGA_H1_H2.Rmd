---
title: "2_EGA_H1_H2_240805"
author: "Arturo Bertero"
date: "2024-08-05"
output: html_document
---

# Libraries

```{r}
#packages
library("pacman")
p_load(tidyverse, here, sjlabelled, stringr, glue, janitor, haven, stargazer, 
       ltm, skimr, readxl, naniar, conflicted, EGAnet, qgraph, lavaan, psychTools,
       psychonetrics)

#remove scientific notation
options(scipen=999)

#conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
```

# Input

```{r}
# Import attitudes
IPBS = readRDS((here("Input", "IPBS.rds")))
```

# Processing

## H1: EGA

```{r}
#1: Fit EGA
ega_results = EGA(IPBS, model = "glasso", algorithm = "walktrap")

#2: summary
summary(ega_results)

# 3: stability
ega_boot = bootEGA(data = IPBS, seed = 1, ncores = 8, iter = 1000)

# 4: summary of bootEGA
summary(ega_boot)

# 5: compare EGA and bootEGA
ega_compare <- compare.EGA.plots(
  ega_results, ega_boot,
  labels = c("Empirical", "Bootstrap"))

# 6: stability plot
dimensionStability(ega_boot)

# 7: hierarchical EGA
ega_hie = hierEGA(IPBS)

# 8: EGA fit
ega_fit = EGA.fit(IPBS)
summary(ega_fit)
```

```{r}
#Comparison with CFA

# CFA on EGA's suggestions (2 factors)
#ega_cfa = CFA(ega_results, IPBS, "WLSMV")

# Additional fit measures
#lavaan::fitMeasures(ega_cfa$fit, fit.measures = "all")
```


```{r}
# mono-dimensional cfa
uni_model <- '
  Factor1 =~ c_adopt + c_abort + c_eutha + c_marri + c_immig + e_redis + 
  e_flatt + e_mwage + e_citin + e_busin
'

# Fit the unidimensional model
fit_uni <- cfa(uni_model, data = IPBS)

# Print the summary of the unidimensional model fit
summary(fit_uni, fit.measures = TRUE)

# bi dimensional cfa
bi_model <- '
  Factor1 =~ c_adopt + c_abort + c_eutha + c_marri + c_immig + e_flatt
  Factor2 =~  e_redis + e_mwage + e_citin + e_busin
'
# Fit the unidimensional model
fit_bi <- cfa(bi_model, data = IPBS)

# Print the summary of the unidimensional model fit
summary(fit_bi, fit.measures = TRUE)

# Extract the standardized solution
standardized_solution <- standardizedSolution(fit_bi)

# Filter to get the correlation between the latent factors
latent_correlation <- standardized_solution %>%
  filter(op == "~~" & lhs == "Factor1" & rhs == "Factor2")

# Print the correlation
print(latent_correlation) #0.538	[0.487;0.588]

#COMPARISON
anova(fit_uni, fit_bi)
```
Interpretation
Degrees of Freedom (Df):

The bidimensional model (fit_bi) has 34 degrees of freedom, while the unidimensional model (fit_uni) has 35 degrees of freedom. This indicates that the unidimensional model has one additional constraint compared to the bidimensional model.
AIC and BIC:

Both the AIC and BIC are lower for the bidimensional model compared to the unidimensional model. Lower values of AIC and BIC indicate a better fit of the model to the data. Thus, the bidimensional model is preferred over the unidimensional model based on these criteria.
Chi-Square (Chisq):

The Chi-Square value for the bidimensional model is 465.25, while it is 1108.93 for the unidimensional model. A lower Chi-Square value indicates a better fit to the data, so the bidimensional model fits the data better than the unidimensional model.
Chi-Square Difference (Chisq diff):

The Chi-Square difference between the two models is 643.68. This large difference indicates a substantial improvement in fit when moving from the unidimensional to the bidimensional model.
RMSEA:

The RMSEA value for the unidimensional model is 0.69048, which is quite high. Typically, RMSEA values less than 0.06 indicate a good fit. This high RMSEA suggests that the unidimensional model does not fit the data well.
P-value (Pr(>Chisq)):

The p-value is less than 0.00000000000000022, which is highly significant (indicated by the '***'). This significant p-value suggests that the bidimensional model fits the data significantly better than the unidimensional model.
Conclusion
Based on the AIC, BIC, Chi-Square values, and the highly significant p-value, the bidimensional model (fit_bi) is a significantly better fit for the data compared to the unidimensional model (fit_uni). The bidimensional model should be preferred for representing the structure of your data.

## H2: network versus latent
I test bidimensional network model vs bidimensional latent model

```{r}
# Load Bork's Method Function
source(here("Processing", "Bork method function.R"))

# Define and Fit the Latent Variable Model
lvm_model <- '
  Factor1 =~ c_adopt + c_abort + c_eutha + c_marri + c_immig + e_flatt
  Factor2 =~  e_redis + e_mwage + e_citin + e_busin
'
lvm_fit <- lavaan::cfa(lvm_model, data = IPBS)
lvm_fit_measures <- lavaan::fitMeasures(lvm_fit)
print(lvm_fit_measures)

# Prepare Data for Network Model
IPBS_matrix <- cor_auto(IPBS)
n <- nrow(IPBS)

# Fit the Network Model
saturated_model <- ggm(covs = (n - 1) / n * IPBS_matrix, omega = "Full", nobs = n)
pruned_model <- saturated_model %>% prune(alpha = 0.01, recursive = TRUE)
final_model <- pruned_model %>% stepup()
adjacency <- 1 * (getmatrix(final_model, "omega") != 0)

network_model <- ggm(covs = (n - 1) / n * IPBS_matrix, omega = adjacency, nobs = n)
results_network_model <- network_model %>% runmodel
fit_measures_network <- fit(results_network_model)
print(fit_measures_network)

# Manual Comparison of Key Fit Indices
comparison <- data.frame(
  Model = c("Factor Model", "Network Model"),
  CFI = c(lvm_fit_measures["cfi"], fit_measures_network$CFI),
  TLI = c(lvm_fit_measures["tli"], fit_measures_network$TLI),
  RMSEA = c(lvm_fit_measures["rmsea"], fit_measures_network$RMSEA),
  AIC = c(lvm_fit_measures["aic"], fit_measures_network$AIC),
  BIC = c(lvm_fit_measures["bic"], fit_measures_network$BIC)
)
print(comparison)

# Apply Bork's Method for Model Selection
bork_result <- Bork_fun(IPBS, lvm_fit, results_network_model)
print(bork_result)



```

```{r}
#example

```


